<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Request System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: #333;
        }

        header {
            background: #35424a;
            color: #ffffff;
            padding: 15px 0;
            text-align: center;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav ul li {
            display: inline;
            margin: 0 10px;
        }

        nav ul li a {
            color: #ffffff;
            text-decoration: none;
        }

        main {
            max-width: 90%;
            margin: 20px auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            color: #35424a;
        }

        section {
            display: none;
            margin-bottom: 20px;
        }

        section.active {
            display: block;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        button {
            background-color: #35424a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #4b5a63;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            overflow-x: auto;
            min-width: 600px;
        }

        table, th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #ffffff;
            color: rgb(0, 0, 0);
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr:hover {
            background-color: #ddd;
        }

        #manager-section {
            padding: 20px;
        }

        #tenant-table-container {
            overflow-x: auto;
        }

        @media (max-width: 768px) {
            nav ul li {
                display: block;
                margin: 5px 0;
            }

            main {
                padding: 15px;
            }

            table, th, td {
                font-size: 14px;
                padding: 8px;
            }
        }

        footer {
            text-align: center;
            padding: 15px 0;
            background: #35424a;
            color: white;
            position: relative;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <header>
        <h1>Maintenance Request System</h1>
        <nav>
            <ul>
                <li><a href="#" onclick="showSection('tenant-section')">Maintenance Form</a></li>
                <li><a href="#" onclick="showSection('staff-section')">Staff Section</a></li>
                <li><a href="#" onclick="showSection('manager-section')">Manager Section</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="tenant-section" class="active">
            <h2>Tenant: Submit Maintenance Request</h2>
            <form id="maintenance-request-form">
                <label for="apartment-number">Apartment Number:</label>
                <input type="text" id="apartment-number" required>

                <label for="problem-area">Area of Problem:</label>
                <select id="problem-area" required>
                    <option value="kitchen">Kitchen</option>
                    <option value="bathroom">Bathroom</option>
                    <option value="living-room">Living Room</option>
                    <option value="bedroom">Bedroom</option>
                    <option value="other">Other</option>
                </select>

                <label for="problem-description">Description of Problem:</label>
                <textarea id="problem-description" required></textarea>

                <button type="submit">Submit Request</button>
            </form>
        </section>

        <section id="staff-section">
            <h2>Staff: Browse Maintenance Requests</h2>
            <form id="filter-form">
                <label for="filter-apartment-number">Filter by Apartment Number:</label>
                <input type="text" id="filter-apartment-number">

                <label for="filter-area">Filter by Area:</label>
                <select id="filter-area">
                    <option value="">All</option>
                    <option value="kitchen">Kitchen</option>
                    <option value="bathroom">Bathroom</option>
                    <option value="living-room">Living Room</option>
                    <option value="bedroom">Bedroom</option>
                </select>

                <label for="filter-date-range">Filter by Date Range:</label>
                <input type="date" id="start-date">
                <input type="date" id="end-date">

                <label for="filter-status">Filter by Status:</label>
                <select id="filter-status">
                    <option value="">All</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                </select>

                <button type="submit">Apply Filters</button>
            </form>

            <h3>Requests:</h3>
            <table id="requests-table">
                <thead>
                    <tr>
                        <th>Request ID</th>
                        <th>Apartment Number</th>
                        <th>Area</th>
                        <th>Description</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="manager-section">
            <h2>Manager: Manage Tenants</h2>
            <form id="tenant-management-form">
                <h3>Add New Tenant</h3>
                <label for="tenant-name">Name:</label>
                <input type="text" id="tenant-name" required>

                <label for="tenant-phone">Phone Number:</label>
                <input type="tel" id="tenant-phone" required>

                <label for="tenant-email">Email:</label>
                <input type="email" id="tenant-email" required>

                <label for="check-in-date">Check-in Date:</label>
                <input type="date" id="check-in-date" required>

                <label for="check-out-date">Check-out Date:</label>
                <input type="date" id="check-out-date" required>

                <label for="tenant-apartment-number">Apartment Number:</label>
                <input type="text" id="tenant-apartment-number" required>

                <button type="submit">Add Tenant</button>
            </form>

            <h3>Move or Delete Tenant</h3>
            <label for="tenant-id">Tenant ID:</label>
            <input type="text" id="tenant-id" required>

            <label for="new-apartment-number">New Apartment Number:</label>
            <input type="text" id="new-apartment-number">

            <button id="move-tenant-button">Move Tenant</button>
            <button id="delete-tenant-button">Delete Tenant</button>

            <h3>Tenant List</h3>
            <table id="tenant-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Check-in Date</th>
                        <th>Check-out Date</th>
                        <th>Apartment Number</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Maintenance Request System</p>
    </footer>

    <script type="module">
        // Firebase setup - REMEMBER TO REMOVE API KEYS BEFORE PUSHING TO PROD!
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

        // TODO: Move this to environment variables before deployment
        const firebaseConfig = {
            apiKey: "AIzaSyCd19lPR9u7xh0T1fHdsSbE9peW7uZXzNc",
            authDomain: "maintenance-request-849cd.firebaseapp.com",
            projectId: "maintenance-request-849cd",
            storageBucket: "maintenance-request-849cd.firebasestorage.app",
            messagingSenderId: "767023579598",
            appId: "1:767023579598:web:281dd288b57a2c4861eb9f",
            measurementId: "G-YY5L2962LW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Handles switching between different sections (tenant, staff, manager views)
        // Also saves last active section to localStorage for better UX
        window.showSection = function(sectionId) {
            document.querySelectorAll("main > section").forEach(section => section.classList.remove("active"));
            document.getElementById(sectionId).classList.add("active");
            localStorage.setItem("activeSection", sectionId);
        };

        // Restore last active section on page load
        window.addEventListener("load", () => {
            showSection(localStorage.getItem("activeSection") || "tenant-section");
        });

        // Fetches and displays all maintenance requests in the staff view
        // Each request gets a "Complete" button that updates its status
        async function loadRequests() {
            const requestsTable = document.querySelector("#requests-table tbody");
            requestsTable.innerHTML = "";

            const requestsSnapshot = await getDocs(collection(db, "maintenanceRequests"));
            requestsSnapshot.forEach((doc) => {
                // Table population logic remains unchanged
            });
        }

        // Loads all tenant data into the manager view table
        async function loadTenants() {
            const tenantTableBody = document.querySelector("#tenant-table tbody");
            tenantTableBody.innerHTML = "";

            const tenantsSnapshot = await getDocs(collection(db, "tenants"));
            tenantsSnapshot.forEach((doc) => {
                // Table population logic remains unchanged
            });
        }

        // Handles the filtering system in staff view
        // Can filter by apartment, area, and request status
        async function applyFilters() {
            const apartmentNumber = document.getElementById('filter-apartment-number').value;
            const area = document.getElementById('filter-area').value;
            const status = document.getElementById('filter-status').value;

            // Build query based on selected filters
            let q = query(collection(db, "maintenanceRequests"));
            if (apartmentNumber) q = query(q, where("apartmentNumber", "==", apartmentNumber));
            if (area) q = query(q, where("problemArea", "==", area));
            if (status) q = query(q, where("status", "==", status));

            // Rest of filtering logic remains unchanged
        }

        // FORM HANDLERS

        // Handles new maintenance request submission from tenants
        document.getElementById('maintenance-request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                // Creates new maintenance request doc in Firebase
                await addDoc(collection(db, "maintenanceRequests"), {
                    apartmentNumber: document.getElementById('apartment-number').value,
                    problemArea: document.getElementById('problem-area').value,
                    problemDescription: document.getElementById('problem-description').value,
                    date: new Date(),
                    status: "pending"
                });
                alert("Request submitted successfully!");
                e.target.reset();
                loadRequests();
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });

        // Handles new tenant registration in manager view
        document.getElementById('tenant-management-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                // Creates new tenant doc in Firebase
                await addDoc(collection(db, "tenants"), {
                    name: document.getElementById('tenant-name').value,
                    phone: document.getElementById('tenant-phone').value,
                    email: document.getElementById('tenant-email').value,
                    checkInDate: document.getElementById('check-in-date').value,
                    checkOutDate: document.getElementById('check-out-date').value,
                    apartmentNumber: document.getElementById('tenant-apartment-number').value
                });
                alert("Tenant added successfully!");
                e.target.reset();
                loadTenants();
                location.reload();
            } catch (e) {
                console.error("Error adding tenant: ", e);
            }
        });

        // Handles moving tenant to new apartment
        // FIXME: Should probably add validation to check if new apartment is available
        document.getElementById('move-tenant-button').onclick = async () => {
            const tenantId = document.getElementById('tenant-id').value;
            const newApartmentNumber = document.getElementById('new-apartment-number').value;

            if (!tenantId || !newApartmentNumber) {
                alert("Please enter both tenant ID and new apartment number.");
                return;
            }

            try {
                const tenantRef = doc(db, "tenants", tenantId);
                await updateDoc(tenantRef, {
                    apartmentNumber: newApartmentNumber
                });
                alert("Tenant's apartment number updated successfully!");
                document.getElementById('tenant-id').value = '';
                document.getElementById('new-apartment-number').value = '';
                loadTenants();
                location.reload();
            } catch (e) {
                console.error("Error updating tenant's apartment number: ", e);
                alert("An error occurred while updating the apartment number. Please check if the tenant ID is correct.");
            }
        };

        // WARNING: This permanently deletes tenant and their maintenance requests
        // Maybe should add an archive feature instead?
        document.getElementById('delete-tenant-button').onclick = async () => {
            const tenantId = document.getElementById('tenant-id').value;

            if (!tenantId) {
                alert("Please enter a tenant ID to delete.");
                return;
            }

            try {
                const tenantRef = doc(db, "maintenanceRequests", tenantId);
                const tenantRef2 = doc(db, "tenants", tenantId);
                await deleteDoc(tenantRef);
                await deleteDoc(tenantRef2);
                alert("Tenant deleted successfully!");
                loadRequests();
                location.reload();
            } catch (e) {
                console.error("Error deleting tenant: ", e);
                alert("An error occurred while deleting the tenant.");
            }
        };

        // Initial data load
        loadRequests();
        loadTenants();
    </script>
</body>
</html>